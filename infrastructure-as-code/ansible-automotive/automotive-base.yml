---
    - hosts: automotive
      become: true
      tasks:
          - name: Apt install packages
            apt: name={{item}} state=present update_cache=yes
            with_items:
                - can-utils
                - git
                - autoconf
                - openjdk-8-jdk
                - maven
                - wireshark
          
          - name: enable mods at boot
            lineinfile: dest=/etc/modules line={{item}} state=present
            with_items:
                - "can"
                - "can_raw"
                - "slcan"
                - "vcan"

          - name: Enable vcan module
            modprobe: name={{item}} state=present
            with_items:
                - can
                - can_raw
                - slcan
                - vcan

          - name: Get can-isotp.ko
            git: repo=https://github.com/hartkopp/can-isotp-modules/ dest=/opt/can-modules
            notify: rebuild isotp

          - name: Get socketcand
            git: repo=https://github.com/dschanoeh/socketcand dest=/opt/socketcand

          - name: Get Kayak
            git: repo=https://github.com/dschanoeh/Kayak dest=/opt/kayak
            notify: build kayak

      handlers:
          - name: rebuild isotp
            command: ./make_isotp.sh
            args:
                chdir: /opt/can-modules/net/can
            notify: load isotp

          - name: load isotp
            command: insmod ./can-isotp.ko
            args:
                chdir: /opt/can-modules/net/can

          - name: build kayak
            command: mvn clean install
            args:
                chdir: /opt/kayak/
            notify: install kayak

          - name: install kayak
            file:
                src: /opt/kayak/application/target/kayak/bin/kayak
                dest: /usr/bin/kayak
                state: link
                mode: 0755
